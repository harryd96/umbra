<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Call Tracker + Prospecting</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 (UMD) + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel for in-browser JSX transform -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
</head>
<body class="antialiased">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // ---------- Constants ----------
    const ALLOWED_USERS = ["harry.doling", "brendan.hill", "raff.nunn"];
    const LS_CURRENT_USER = "oct_current_user";          // selected username
    const LS_DATA_PREFIX = "oct_data_";                  // call records per user
    const LS_PROSPECT_PREFIX = "oct_prospects_";         // prospect queue per user

    // ---------- Utils ----------
    function formatUKTimestamp(date = new Date()) {
      const parts = new Intl.DateTimeFormat("en-GB", {
        timeZone: "Europe/London",
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      }).formatToParts(date);
      const get = (type) => parts.find((p) => p.type === type)?.value || "";
      return `${get("day")} ${get("month")} ${get("year")}, ${get("hour")}.${get("minute")}${(get("dayPeriod") || "").toLowerCase()}`;
    }
    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function normalizeNumber(n) { return (n || "").replace(/\D+/g, ""); }

    function loadCurrentUser() { try { return localStorage.getItem(LS_CURRENT_USER) || ""; } catch { return ""; } }
    function saveCurrentUser(username) { try { username ? localStorage.setItem(LS_CURRENT_USER, username) : localStorage.removeItem(LS_CURRENT_USER); } catch {} }
    function loadUserData(username) { try { const raw = localStorage.getItem(LS_DATA_PREFIX + username); return raw ? JSON.parse(raw) : []; } catch { return []; } }
    function saveUserData(username, records) { try { localStorage.setItem(LS_DATA_PREFIX + username, JSON.stringify(records)); } catch {} }
    function loadProspects(username) { try { const raw = localStorage.getItem(LS_PROSPECT_PREFIX + username); return raw ? JSON.parse(raw) : []; } catch { return []; } }
    function saveProspects(username, prospects) { try { localStorage.setItem(LS_PROSPECT_PREFIX + username, JSON.stringify(prospects)); } catch {} }

    // ---------- Top bar (Login/Logout + Prospecting Mode) ----------
    function TopBar({ currentUser, onLogin, onLogout, onToggleMode, isProspecting }) {
      const [open, setOpen] = useState(false);
      const [username, setUsername] = useState("");
      const [error, setError] = useState("");
      const modeButtonLabel = isProspecting ? "Calling Mode" : "Prospecting Mode";
      return (
        <header className="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-b">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-2">
            {currentUser ? (
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-600">{currentUser}</span>
                <button className="px-4 py-2 text-sm rounded-xl border border-gray-300 hover:bg-gray-50" onClick={onLogout}>Log out</button>
              </div>
            ) : (
              <button className="px-4 py-2 text-sm rounded-xl border border-gray-300 shadow-sm hover:bg-gray-50" onClick={() => setOpen(true)}>Log in</button>
            )}

            <button className="ml-auto px-4 py-2 text-sm rounded-xl border border-gray-300 shadow-sm hover:bg-gray-50" onClick={onToggleMode}>
              {modeButtonLabel}
            </button>
          </div>

          {open && !currentUser && (
            <div className="fixed inset-0 bg-black/30 flex items-center justify-center">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6">
                <input
                  autoFocus
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value.trim())}
                  placeholder="Username"
                  className="w-full border rounded-xl px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-black/20"
                  onKeyDown={(e) => {
                    if (e.key === "Enter") {
                      if (!ALLOWED_USERS.includes(username)) { setError("Unknown username"); return; }
                      onLogin(username); setOpen(false);
                    }
                    if (e.key === "Escape") setOpen(false);
                  }}
                />
                {error && <div className="text-sm text-red-600 mb-3">{error}</div>}
                <div className="flex justify-end gap-2">
                  <button className="px-3 py-2 rounded-xl border border-gray-300" onClick={() => setOpen(false)}>Cancel</button>
                  <button
                    className="px-4 py-2 rounded-xl bg-black text-white"
                    onClick={() => {
                      if (!ALLOWED_USERS.includes(username)) { setError("Unknown username"); return; }
                      onLogin(username); setOpen(false);
                    }}
                  >
                    Submit
                  </button>
                </div>
              </div>
            </div>
          )}
        </header>
      );
    }

    // ---------- Input panel (add + edit mode, arrow-key hotkeys) ----------
    function InputPanel({ currentUser, onAdd, onSaveEdit, onCancelEdit, editingRecord }) {
      const [name, setName] = useState("");
      const [number, setNumber] = useState("");
      const [notes, setNotes] = useState("");
      const nameRef = useRef(null);
      const numberRef = useRef(null);
      const notesRef = useRef(null);

      useEffect(() => { nameRef.current?.focus(); }, [currentUser]);
      useEffect(() => {
        if (editingRecord) {
          setName(editingRecord.name || "");
          setNumber(editingRecord.number || "");
          setNotes(editingRecord.notes || "");
          nameRef.current?.focus();
        }
      }, [editingRecord]);

      const submit = () => {
        if (!currentUser) return;
        if (!name.trim() && !number.trim() && !notes.trim()) return;
        if (editingRecord) {
          onSaveEdit({ ...editingRecord, name: name.trim(), number: number.trim(), notes: notes.trim() });
          return;
        }
        const record = {
          id: uid(),
          name: name.trim(),
          number: number.trim(),
          notes: notes.trim(),
          timestamp: formatUKTimestamp(new Date()),
          createdAtISO: new Date().toISOString(),
        };
        onAdd(record);
        setName(""); setNumber(""); setNotes("");
        nameRef.current?.focus();
      };
      const resetFields = () => { setName(""); setNumber(""); setNotes(""); nameRef.current?.focus(); };

      useEffect(() => {
        const handleKeyDown = async (e) => {
          if (e.key === "Enter" && (name || number || notes)) { e.preventDefault(); submit(); }
          if (e.key === "ArrowLeft") { e.preventDefault(); nameRef.current?.focus(); }
          if (e.key === "ArrowDown") { e.preventDefault(); numberRef.current?.focus(); }
          if (e.key === "ArrowRight") { e.preventDefault(); notesRef.current?.focus(); }
          if (e.key === "ArrowUp") {
            e.preventDefault();
            try { const clip = await navigator.clipboard.readText(); if (clip) { setNumber(clip); numberRef.current?.focus(); } } catch {}
          }
        };
        window.addEventListener("keydown", handleKeyDown);
        return () => window.removeEventListener("keydown", handleKeyDown);
      }, [name, number, notes, editingRecord]);

      return (
        <div className="flex flex-col">
          <div className="flex flex-col gap-3">
            <input ref={nameRef} type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Name" className="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/20" />
            <input ref={numberRef} type="tel" value={number} onChange={(e) => setNumber(e.target.value)} placeholder="Number" className="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/20" />
            <textarea ref={notesRef} value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Notes" className="w-full h-40 border rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-black/20" />
          </div>
          <div className="mt-4 flex gap-2">
            {!editingRecord ? (
              <button disabled={!currentUser} onClick={submit} className={`${currentUser ? "bg-black text-white" : "bg-gray-200 text-gray-500"} px-4 py-2 rounded-xl`}>Add record</button>
            ) : (
              <>
                <button className="px-4 py-2 rounded-xl bg-black text-white" onClick={submit}>Save changes</button>
                <button className="px-4 py-2 rounded-xl border border-gray-300" onClick={() => { onCancelEdit(); resetFields(); }}>Cancel</button>
              </>
            )}
          </div>
          {!currentUser && <p className="text-sm text-red-600 mt-2">Log in to save entries.</p>}
        </div>
      );
    }

    // ---------- Search panel (list + edit/delete) ----------
    function SearchPanel({ records, onDelete, onEdit }) {
      const [q, setQ] = useState("");

      const results = useMemo(() => {
        const qt = q.trim();
        const ql = qt.toLowerCase();
        const qn = normalizeNumber(qt);

        const hasText = ql.length > 0;
        const hasDigits = qn.length > 0;

        if (!hasText && !hasDigits) return records;

        return records.filter((r) => {
          const nameMat
